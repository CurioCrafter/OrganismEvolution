name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.3

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64 -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config Release --parallel

    - name: Build Tests
      run: cmake --build build --config Release --target test_genome test_neural_network test_spatial_grid test_integration test_performance

    - name: Run Tests
      run: |
        cd build
        ctest --config Release --output-on-failure --timeout 120
      continue-on-error: false

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: build/Testing/

  # Quick sanity check on push
  quick-test:
    runs-on: windows-latest
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Configure and Build
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DBUILD_TESTS=ON
        cmake --build build --config Release --target test_genome test_neural_network

    - name: Run Core Tests
      run: |
        cd build
        ctest --config Release -R "GenomeTests|NeuralNetworkTests" --output-on-failure --timeout 60
