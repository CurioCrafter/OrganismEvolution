# Phase 8 Agent 7: Run-to-Run World Variety

## Overview

This document describes the world variety system implemented to ensure every run of the simulation generates a unique planet with distinct terrain, vegetation, colors, and ecosystem dynamics while remaining fully deterministic when a seed is provided.

## Seed System

### Session Seed Override

When `config.seed == 0`, the system generates a time-based seed:

```cpp
// Location: src/environment/ProceduralWorld.cpp:20-47
uint32_t ProceduralWorld::ensureSeed(uint32_t seed) {
    if (seed == 0) {
        // High-resolution time + random device for maximum entropy
        auto now = std::chrono::high_resolution_clock::now();
        uint64_t timeSeed = duration_cast<milliseconds>(now.time_since_epoch()).count();
        uint32_t randomPart = m_rd();

        // Splitmix64-style combination
        uint64_t combined = timeSeed ^ (static_cast<uint64_t>(randomPart) << 32);
        // ... mixing steps ...

        m_wasAutoGenerated = true;
        return result;
    }
    m_wasAutoGenerated = false;
    return seed;
}
```

### Seed Fingerprint Format

Seeds are displayed as 6-character memorable codes: `A7X-Q3M`

This fingerprint is derived from the master seed and provides a shareable world identifier.

### Sub-Seed Derivation

The master seed derives 11 specialized sub-seeds:

| Sub-Seed | Purpose | Derived Values |
|----------|---------|----------------|
| paletteSeed | Colors, atmosphere, sky | Sky hue, water color, sun color |
| climateSeed | Temperature, humidity | Biome distribution, weather |
| terrainSeed | Elevation, mountains | Noise octaves, erosion strength |
| vegetationSeed | Plant density | Tree/grass/flower density |
| oceanSeed | Water features | Coastline, reef density |
| biomeSeed | Biome assignment | Biome weights |
| creatureSeed | Genetics | Initial creature traits |
| weatherSeed | Weather patterns | Storm frequency, wind |
| archipelagoSeed | Island layout | Island count, spacing |
| chemistrySeed | Biochemistry | Available nutrients |
| lifeSeed | Creature spawning | Starting population |

## Star Type System

### Spectral Classes

```cpp
enum class StarSpectralClass {
    O_BLUE_GIANT,      // 1% - Hot blue-white, +15C offset
    B_BLUE,            // 2% - Hot blue, +8C offset
    A_WHITE,           // 5% - White, +3C offset
    F_YELLOW_WHITE,    // 12% - Yellow-white, +1C offset
    G_YELLOW,          // 30% - Sun-like (default)
    K_ORANGE,          // 25% - Orange, -5C offset
    M_RED_DWARF,       // 20% - Red, -15C offset
    BINARY_SYSTEM,     // 2% - Two suns, shorter day
    RED_GIANT,         // 2% - Large red, -8C offset
    WHITE_DWARF        // 1% - Tiny bright, -25C offset
};
```

### Star Effects on World

| Property | Effect |
|----------|--------|
| `color` | Affects sky tint and lighting color |
| `intensity` | Global brightness multiplier |
| `temperatureOffset` | Global temperature shift (C) |
| `uvIntensity` | Affects creature mutation rates |
| `dayLengthModifier` | Speed of day/night cycle |
| `twilightDuration` | Length of dawn/dusk |
| `skyTintModifier` | RGB multiplier for sky colors |

### Shader Integration

Access star parameters in shaders via:

```cpp
ProceduralWorld::StarShaderParams params = world.getStarShaderParams();
// params.starColor, params.starIntensity, params.skyTintModifier, etc.
```

## Palette Ramp System

### Per-Biome Color Ramps

Each biome has 5-point color ramps for key surfaces:

```cpp
struct ColorRamp {
    glm::vec3 cool;      // Blue-shifted variant
    glm::vec3 neutral;   // Base color
    glm::vec3 warm;      // Red-shifted variant
    glm::vec3 vibrant;   // High saturation
    glm::vec3 muted;     // Low saturation
};
```

Biome ramps defined:
- grassBase, grassTip, grassDry
- leafSpring, leafSummer, leafAutumn
- groundBase, rockBase, sandBase

### Contrast Constraints

Adjacent biomes maintain minimum contrast:

| Constraint | Value |
|------------|-------|
| Min hue delta | 20 degrees |
| Min saturation delta | 0.15 |
| Max warmth shift | 0.3-0.5 (biome-dependent) |
| Min biome color distance | 0.15 (RGB) |

### Implemented Biome Ramps

- Grassland (wide green variation, golden undertones)
- Temperate Forest (darker, richer greens)
- Desert (warm sandy tones, muted vegetation)
- Tundra (cold, hardy vegetation colors)
- Tropical Rainforest (vibrant, saturated)
- Wetland (murky greens and browns)
- Savanna, Boreal, Alpine, Volcanic, Coastal

## Region Configuration

### Multi-Island Competition

For archipelago worlds, regions group islands with distinct characteristics:

```cpp
struct RegionConfig {
    int regionId;
    std::vector<int> islandIds;

    // Biome weight overrides (multiply defaults)
    float desertWeight, forestWeight, tundraWeight, tropicalWeight;

    // Climate overrides
    float temperatureOffset;    // C offset
    float moistureMultiplier;   // 0.5-1.5

    // Evolution biases
    EvolutionBiasHook evolutionBias;

    // Connectivity
    float isolationLevel;       // 0 = connected, 1 = isolated
    bool allowsMigration;
};
```

### Evolution Bias Hooks

Per-region creature trait modifiers:

| Bias | Effect (1.0 = neutral) |
|------|------------------------|
| sizeBias | Larger (>1) or smaller (<1) creatures favored |
| speedBias | Faster creatures favored |
| aggressionBias | More aggressive creatures favored |
| predationPressure | Selection pressure from predators |
| venomChance | Probability of venom evolution |
| bioluminescenceChance | Probability of glow traits |

### Preset Regions

```cpp
RegionConfig::tropical()     // High vegetation, flying creatures favored
RegionConfig::arctic()       // Low vegetation, large creatures for warmth
RegionConfig::volcanic()     // Sparse vegetation, venom evolution boost
RegionConfig::competitive()  // High predation, speed/intelligence boosted
```

## Terrain Variability

### Erosion Parameters

```cpp
struct WorldGenConfig {
    int erosionPasses;          // 2-7 (from seed)
    float erosionStrength;      // 0-1
    int noiseOctaves;           // 4-8 (from seed)
    float noiseFrequency;       // 0.5-1.5
};
```

Derived from terrain seed:
- erosionPasses = 2 + (erosionStrength * 5)
- noiseOctaves = 4 + (noiseFrequency * 4)

### Terrain Variation Ranges

| Parameter | Range |
|-----------|-------|
| Water level | 0.25-0.50 |
| Coastline smoothing | 2-5 passes |
| Mountain height | 0.3-0.8 (ridgeBias) |
| Valley depth | 0.0-0.5 (valleyBias) |

## Vegetation Density Presets

### Available Presets

| Preset | Tree | Grass | Flower | Shrub | Alien |
|--------|------|-------|--------|-------|-------|
| SPARSE | 0.3x | 0.4x | 0.2x | 0.3x | 0.0x |
| DEFAULT | 1.0x | 1.0x | 1.0x | 1.0x | 0.0x |
| LUSH | 1.5x | 1.4x | 1.6x | 1.5x | 0.0x |
| ALIEN | 0.8x | 0.6x | 0.4x | 0.5x | 1.2x |
| DEAD | 0.1x | 0.15x | 0.05x | 0.1x | 0.0x |
| OVERGROWN | 2.0x | 1.8x | 1.5x | 2.0x | 0.2x |

### Distribution

- 15% SPARSE
- 45% DEFAULT
- 25% LUSH
- 7% ALIEN
- 5% OVERGROWN
- 3% DEAD

## Agent 9 Shader Getters

The following methods expose world parameters for shader use:

### Palette Variation

```cpp
PaletteVariation ProceduralWorld::getCurrentPaletteVariation() const;

struct PaletteVariation {
    float skyHue;           // 0-360
    float skySaturation;    // 0.5-1.2
    float skyBrightness;    // 0.7-1.3
    float fogDensity;       // 0.01-0.05
    float fogDistance;      // 50-150
    float waterHue;         // 180-240
    float waterClarity;     // 0.3-0.9
    float sunHue;           // 30-60
    float sunIntensity;     // 0.8-1.2
    float biomeSaturation;  // 0.7-1.3
    float warmth;           // -0.5 to 0.5
    float vegetationDensity;// 0.5-1.5
};
```

### Terrain Parameters

```cpp
TerrainShaderParams ProceduralWorld::getTerrainShaderParams() const;

struct TerrainShaderParams {
    float erosionStrength;  // 0-1
    float ridginess;        // 0-1
    float valleyDepth;      // 0-1
    float noiseFrequency;   // 0.5-1.5
    int noiseOctaves;       // 4-8
};
```

### Star Parameters

```cpp
StarShaderParams ProceduralWorld::getStarShaderParams() const;

struct StarShaderParams {
    glm::vec3 starColor;        // RGB
    float starIntensity;        // 0.3-2.0
    glm::vec3 skyTintModifier;  // RGB multiplier
    float dayLengthModifier;    // 0.8-1.5
    float twilightDuration;     // 0.5-2.0
    float temperatureOffset;    // -25 to +15 C
    bool isBinarySystem;        // Two suns
};
```

### Region Access

```cpp
const RegionConfig* ProceduralWorld::getRegionConfig(int islandId) const;
const MultiRegionConfig& ProceduralWorld::getMultiRegionConfig() const;
int ProceduralWorld::getRegionAtPosition(const glm::vec3& worldPos) const;
```

## Validation

### Run-to-Run Uniqueness Test

1. Launch 3 consecutive runs without explicit seed
2. Verify visible differences in:
   - Sky color and atmosphere
   - Terrain shape and erosion
   - Vegetation density and colors
   - Water color and clarity

### Determinism Test

1. Run with seed = 12345
2. Record world fingerprint and visual characteristics
3. Run again with seed = 12345
4. Verify exact match

### Files Modified

- `src/environment/ProceduralWorld.h` - StarType, RegionConfig, VegetationDensityConfig
- `src/environment/ProceduralWorld.cpp` - Implementation of all variety systems
- `src/environment/BiomePalette.h` - ColorRamp, PaletteRampRegistry
- `src/environment/BiomePalette.cpp` - Biome-specific ramp implementations

### Parallel Safety

Owned files (Agent 7):
- src/environment/ProceduralWorld.*
- src/environment/PlanetTheme.*
- src/environment/BiomePalette.*
- src/environment/GrassSystem.*
- src/environment/VegetationManager.*
- src/environment/TreeGenerator.*
- src/environment/ArchipelagoGenerator.*
- src/environment/ClimateSystem.*
- src/environment/Terrain.*
- src/environment/TerrainErosion.*
- src/environment/BiomeSystem.*

Do NOT modify:
- src/environment/PlanetSeed.* (Agent 3)
- src/ui/* (Agent 8)

## Usage Example

```cpp
// Auto-generate unique world
WorldGenConfig config;
config.seed = 0;  // Auto-generate
ProceduralWorld world;
GeneratedWorld result = world.generate(config);

// Log shows: "Seed: 3847291847 [A7X-Q3M] (Auto-generated)"

// Get shader parameters for Agent 9
auto palette = world.getCurrentPaletteVariation();
auto terrain = world.getTerrainShaderParams();
auto star = world.getStarShaderParams();

// Get vegetation config
const auto& vegConfig = world.getVegetationConfig();

// Get region for an island
const RegionConfig* region = world.getRegionConfig(islandId);
```
